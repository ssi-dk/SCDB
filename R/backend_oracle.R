# dbplyr needs additional implementation for Oracle to work.

# The ANALYZE TABLE command generated by dplyr does not work for Oracle, so we manually implement.
#' @exportS3Method dbplyr::sql_table_analyze
sql_table_analyze.JDBCConnection <- function(con, table, ...) {
  dbplyr::build_sql(
    "ANALYZE TABLE ",
    dbplyr::as.sql(id(table, conn = con), con = con),
    " COMPUTE STATISTICS",
    con = con
  )
}

#' @importFrom rJava .jcall
#' @export
setMethod("dbGetRowsAffected", "JDBCResult", function(res, ...) {
  if (!is.null(res@stat)) {
    tryCatch({
      cnt <- rJava::.jcall(res@stat, "I", "getUpdateCount")
      return(if (cnt < 0) 0L else as.integer(cnt))
    }, error = function(e) {
      return(NA_integer_)
    })
  }
  return(NA_integer_)
})
